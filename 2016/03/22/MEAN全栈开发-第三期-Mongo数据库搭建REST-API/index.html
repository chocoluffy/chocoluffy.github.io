<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="O92Q-a9Vf5dWXDW5Df-7NMxOta1TkJyuJddQxTM-n4U" />




  <meta name="baidu-site-verification" content="4TeaTL6Cbs" />







  
  
    
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <link rel="amphtml" href="./amp/index.html">



  <meta name="keywords" content="javascript,nodejs,web design," />





  <link rel="alternate" href="/atom.xml" title="余舜哲的 One Piece" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.0.1" />






<meta name="description" content="AirLoft的原型。 第三期， 基于mongodb的mongoose来搭建RESTful API， 主要包括了关于各类涉及到对象的GET, POST, PUT DELETE方法的实现。 在postman上不断的模拟， 也最终搭好一个稳定且flexible的后端API处理， 剩下的就是将数据库和这个Express App的controller结合， 并在前端上灵活的应用啦！如果说前端就像一个人的妆">
<meta name="keywords" content="javascript,nodejs,web design">
<meta property="og:type" content="article">
<meta property="og:title" content="MEAN全栈开发[第三期-Mongo数据库搭建REST API]">
<meta property="og:url" content="http://chocoluffy.com/2016/03/22/MEAN全栈开发-第三期-Mongo数据库搭建REST-API/index.html">
<meta property="og:site_name" content="余舜哲的 One Piece">
<meta property="og:description" content="AirLoft的原型。 第三期， 基于mongodb的mongoose来搭建RESTful API， 主要包括了关于各类涉及到对象的GET, POST, PUT DELETE方法的实现。 在postman上不断的模拟， 也最终搭好一个稳定且flexible的后端API处理， 剩下的就是将数据库和这个Express App的controller结合， 并在前端上灵活的应用啦！如果说前端就像一个人的妆">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/c5ee78b5jw1f26lk141v7j21kw0tjn61.jpg">
<meta property="og:image" content="http://ww3.sinaimg.cn/large/c5ee78b5gw1f1wrkszhcej218w0u6wib.jpg">
<meta property="og:updated_time" content="2018-06-19T04:14:06.787Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MEAN全栈开发[第三期-Mongo数据库搭建REST API]">
<meta name="twitter:description" content="AirLoft的原型。 第三期， 基于mongodb的mongoose来搭建RESTful API， 主要包括了关于各类涉及到对象的GET, POST, PUT DELETE方法的实现。 在postman上不断的模拟， 也最终搭好一个稳定且flexible的后端API处理， 剩下的就是将数据库和这个Express App的controller结合， 并在前端上灵活的应用啦！如果说前端就像一个人的妆">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/c5ee78b5jw1f26lk141v7j21kw0tjn61.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 10766069,
      author: '博主'
    }
  };
</script>

  <title> MEAN全栈开发[第三期-Mongo数据库搭建REST API] | 余舜哲的 One Piece </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', '66874854-1', 'auto');
  ga('send', 'pageview');
</script>




  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=56472517";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">余舜哲的 One Piece</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tech">
          <a href="/tech" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-battery-full"></i> <br />
            
            技术
          </a>
        </li>
      
        
        <li class="menu-item menu-item-life">
          <a href="/life" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            随笔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-books">
          <a href="/books" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bookmark"></i> <br />
            
            书房
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                MEAN全栈开发[第三期-Mongo数据库搭建REST API]
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-22T22:50:55-04:00" content="2016-03-22">
              2016-03-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/技术/" itemprop="url" rel="index">
                    <span itemprop="name">技术</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/22/MEAN全栈开发-第三期-Mongo数据库搭建REST-API/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/03/22/MEAN全栈开发-第三期-Mongo数据库搭建REST-API/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
          <span class="post-visit" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数</span>
              <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
              </span>
          </span>
          

          
          <span>
            &nbsp; | &nbsp;
            <span class="post-meta-item-icon">
              <i class="fa fa-clock-o"></i>
            </span>
            <span class="post-meta-item-text">阅读时长</span>
            <span class="post-count">20 分钟</span>
          </span>
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>AirLoft的原型。 第三期， 基于mongodb的mongoose来搭建RESTful API， 主要包括了关于各类涉及到对象的GET, POST, PUT DELETE方法的实现。 在postman上不断的模拟， 也最终搭好一个稳定且flexible的后端API处理， 剩下的就是将数据库和这个Express App的controller结合， 并在前端上灵活的应用啦！如果说前端就像一个人的妆容， 那么数据库以及API处理就是他的谈吐和内涵， 这个应用也有了scaling的能力， 加油!</p>
<a id="more"></a>
<p><img src="http://ww1.sinaimg.cn/large/c5ee78b5jw1f26lk141v7j21kw0tjn61.jpg" alt="screenshot"></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>In MVC architecture, we need to have views without content or data. An common way to implement MVC architecture is to <strong>first build up a frontend clickable prototype, then extract the content from the view back to controller(concerned with data structure), then back to model.</strong> And now we are in the second step, we try to put variable in jade file in place of content, and put the content as variable into the controller.</p>
<h2 id="Mongoose"><a href="#Mongoose" class="headerlink" title="Mongoose"></a>Mongoose</h2><p>First set up a connection URI like: <code>var dbURI = &#39;mongodb://localhost/airloft&#39;;</code>, username, password and port number is optional for localhost.</p>
<p>A stupid mistake!! Need to open the <code>mongod</code> before you tried to connect to it. One thing to notice is that Mongoose connection doesn’t automatically close when the application restarts or stops. In order to do that whenever we restart the <code>nodemon</code>, we will need to listen for nodejs event. Nodemon uses <code>SIGUSR2</code>, application termination uses <code>SIGINT</code>, Heroku uses <code>SIGTERM</code>, like:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> graceShutDown = <span class="function"><span class="keyword">function</span>(<span class="params">msg, callback</span>)</span>&#123;</span><br><span class="line">	mongoose.connection.close(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="string">'Mongoose is closed through '</span> + msg);</span><br><span class="line">		callback();</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">process.once(<span class="string">'SIGUSR2'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">	graceShutDown(<span class="string">'nodemon restart'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">		process.kill(process.pid, <span class="string">'SIGUSR2'</span>);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>use <code>process.once</code> to overwrite the default <code>SIGUSR2</code> function, but then use <code>kill</code> to resend the <code>SIGUSR2</code> signal again, but this time we hook up a msg display functionality. Especially the place, we use <code>process.once()</code> instead of <code>process.on()</code> in the <code>SIGUSR2</code> case, since nodejs will listen for the same event, and if we use <code>on</code>, then it will forms a infinite loop. Note that <code>process.kill()</code> serves the functionality of sending the signal.</p>
<blockquote>
<p>Recap: Basically four step as discussed here, first define a connection URI string, then second setup the db connection; third monitor the mongoose connection events like <code>connected</code> and <code>disconnected</code>, and fourth monitor the node process event in order to close the db connection when we restart.</p>
</blockquote>
<p>From view to controller, finally to store in db is what we have gone through so far. It works pretty well, since the moment we move the data to the controller, we gradually solidy the data structure we want to use!!</p>
<p>Some technical names: “path” is like attribute names in relational database while “property object” is like the values but like other JS object, can be nested. Also, we can add data validation inside the schema, two advantages: </p>
<ul>
<li>save the roundtrip time to datebase</li>
<li>save the code inside the application for validation.</li>
</ul>
<p>Adding indexes can make database search more efficiently, jist like adding index to the files you want to search in your drawer. In order to add a GeoJSON path into your application, you only need to do this: <code>coords: {type: [Number], index: &#39;2dsphere&#39;}</code>; using <code>2dsphere</code> allows mongodb to be able to calculate the geolocation fast, thus <strong>it is helpful to build a location-based application.</strong></p>
<p>Subdocument is helpful when handling nested data structure, one thing to note, when creating attributes like <code>timestamp</code>, we use data type called <code>Date</code>, like:   </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> reviewSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	rating: &#123;<span class="attr">type</span>: <span class="built_in">Number</span>, <span class="string">"default"</span>: <span class="number">0</span>, <span class="attr">min</span>: <span class="number">0</span>, <span class="attr">max</span>: <span class="number">5</span>&#125;,</span><br><span class="line">	author: <span class="built_in">String</span>,</span><br><span class="line">	createdOn: &#123;<span class="attr">type</span>: <span class="built_in">Date</span>, <span class="string">"default"</span>: <span class="built_in">Date</span>.now&#125;,</span><br><span class="line">	text: <span class="built_in">String</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><img src="http://ww3.sinaimg.cn/large/c5ee78b5gw1f1wrkszhcej218w0u6wib.jpg" alt="mongo"> 这张图讲得很清楚， schema是application-side的东西， 每一个model是的实例instance通过schema可以map到database里面的每一个document, 1:1的对应关系。</p>
<p>While typing in <code>mongod</code> will let you start the mongodatabase, using <code>mongo</code> will start tht shell and let you connect to the test database. And some useful commands in mongo go here:</p>
<ul>
<li><code>show dbs</code> to show all existing database so far.</li>
<li><code>use local</code> to switch to another database. And if that db doesn’t exist yet, mongo will create it for us.</li>
<li><code>show collections</code></li>
<li><code>db.startup_log.find()</code> returns all the content from collection, uesful when we check whether the data has been saved.</li>
<li><code>db.missions.save({...})</code> will savev a new document into collection.</li>
<li><code>db.inventory.remove({})</code> will remove all documents in collection <code>inventory</code>.</li>
<li><code>db.missions.update()</code> will query a document and update its content. The first argument is query string, and second argument use <code>$push</code> to insert subdocuments.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> &gt; db.locations.update(&#123; </span><br><span class="line">   name: <span class="string">'Starcups'</span></span><br><span class="line">  &#125;, &#123; </span><br><span class="line">    $push: &#123;</span><br><span class="line">      reviews: &#123;</span><br><span class="line">        author: <span class="string">'Simon Holmes'</span>,</span><br><span class="line">        id: ObjectId(),</span><br><span class="line">        rating: <span class="number">5</span>,</span><br><span class="line">        timestamp: <span class="keyword">new</span> <span class="built_in">Date</span>(<span class="string">"Jul 16, 2013"</span>),</span><br><span class="line">        reviewText: <span class="string">"What a great place. I can't say enough good things about it."</span></span><br><span class="line">      &#125; </span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>So far, we have insert a fake data document in our local computer, but in real life, <strong>we want database to be externally accessible.</strong> use <code>heroku addons:add mongolab</code> to register a db URI at mongolab as a heroku addons.<strong> And use <code>heroku addons:open mongolab</code> to go the website interface to check database details. </strong>In order to get the uri of the database, type <code>heroku config:get MONGOLAB_URI</code>. </p>
<blockquote>
<p>Note that in real practice, I have to fixed a typo bug from my previous data stored in mongolab, I have to first go to the mongo shell to <code>remove({})</code> and <code>insert({...})</code> again, then do the <code>mongodump</code> and <code>mongorestore</code> again to dump the data into the temp folder at <code>~/tmp</code> and push the data to live database. And make sure to press the “Delete all collection” button before we did <code>mongorestore</code> to avoid same key collision.</p>
</blockquote>
<p>After receive URI, we will first dump our localhost data into a folder in local computer, then restore the data to the live database. use <code>mkdir -p ~/tmp/mongodump</code> will create a folder to hold up the dumped data. Note that use <code>-p</code> option will create the non-existed folders on the path like “tmp”.</p>
<ul>
<li>use <code>mongodump -h localhost:27017 -d airloft -o ~/tmp/mongodump</code> to export airloft.missions data into BSON.</li>
<li>use <code>mongorestore -h &lt;host and port number&gt; -d &lt;live database name&gt; -u &lt;username(same as database name)&gt; -p &lt;password&gt; &lt;path to dump data folder&gt;</code> to push the data up to the mongolab live database.</li>
<li>Last step(testing), we can use <code>mongo hostname:port/database_name -u username -p password</code> to change the <code>mongo</code> to interact with an external database. Note that in the last two steps, database name is the same as username. Then, we can use commands introduced before to interact with live database. In summery, we have one source code and can be used to manipulate databases at two locations, one in local computer, a test database, and one in Heroku, a live database.</li>
</ul>
<p>Let application use right database. use <code>heroku config:set NODE_ENV=production</code> to set the environment variable <code>NODE_ENV</code> to be production for Heroku. <strong>Environment variable will affect the way the core process runs.</strong> When we tried to use <code>nodemon</code> to start application, one way to make sure what environemnt we are running in is to prepend a ENV variable before nodemon like <code>NODE_ENV=production nodemon</code>, and corresponds to this change, we also change the code in db.js(with a if-else block) to set the dbURI aligned with environment. In application, we can access to such variable by <code>process.env.NODE_ENV</code>, but since we post it in public repo, we don’t want our credentials to be public. Instead, we use environment variables from Heroku configuration.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> dbURI = <span class="string">'mongodb://localhost/airloft'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(process.env.NODE_ENV === <span class="string">'production'</span>)&#123;</span><br><span class="line">	dbURI = process.env.MONGOLAB_URI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mongoose.connect(dbURI);</span><br></pre></td></tr></table></figure>
<h2 id="REST-APIs"><a href="#REST-APIs" class="headerlink" title="REST APIs"></a>REST APIs</h2><p>REST is an architecture style, it’s stateless, meaning it will not recognize users or history. Having such program interface will allow us to talk to our database through HTTP and perform CRUD operations then send back a HTTP response. An way to construct URLs is to think about the collections in our database. In ‘airloft.missions’ collection, we may want to allow operations like:</p>
<ul>
<li><code>/missions</code> to create an new mission.</li>
<li><code>/missions</code> to read all missions.</li>
<li><code>/missions/&lt;index&gt;</code> to read a specific mission.</li>
<li><code>/missions/&lt;index&gt;</code> to update a specific mission. And so on so forth.</li>
</ul>
<p>As we can see the urls are same for several operations, and we will use different request methods to tell the server what action to take.</p>
<ul>
<li><code>POST</code> to create new data in database(from submitting form).</li>
<li><code>GET</code> to read data.</li>
<li><code>PUT</code> to update a document.</li>
<li><code>DELETE</code> to delete a document.</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// missions</span></span><br><span class="line">router.get(<span class="string">'/missions'</span>, ctrlMissions.missionsListByDistance);</span><br><span class="line">router.post(<span class="string">'/missions'</span>, ctrlMissions.missionsCreate);</span><br><span class="line">router.get(<span class="string">'/missions/:missionid'</span>, ctrlMissions.missionsReadOne);</span><br><span class="line">router.put(<span class="string">'/missions/:missionid'</span>, ctrlMissions.missionsUpdateOne);</span><br><span class="line">router.delete(<span class="string">'/missions/:missionid'</span>, ctrlMissions.missionsDeleteOne);</span><br></pre></td></tr></table></figure>
<p>Then in the corresponding controller files, we define these functions and fill them with the simplest response to display when received such request.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sendJsonRes = <span class="function"><span class="keyword">function</span>(<span class="params">res, status, content</span>)</span>&#123;</span><br><span class="line">	res.status(status);</span><br><span class="line">	res.json(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.missionsListByDistance = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">	sendJsonRes(res, <span class="number">200</span>, &#123;<span class="string">"status"</span>: <span class="string">"success"</span>&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="“GET”-method-implementation"><a href="#“GET”-method-implementation" class="headerlink" title="“GET” method implementation"></a>“GET” method implementation</h2><p>Some useful queries in Mongoose:</p>
<ul>
<li><code>find</code> general search based on query object.</li>
<li><code>findById</code> look for specific ID.</li>
<li><code>findOne</code> get the first match document.</li>
<li><code>geoNear</code> find geo-closef query.</li>
<li><code>geoSearch</code> add query functionality to geoNear operation.</li>
</ul>
<p>After using queries, we use <code>exec</code> method execute the query and passes a callback function that will run when the operation is complete. The callback function should accept two parameters, an error object and the instance of found document.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> sendJsonRes = <span class="function"><span class="keyword">function</span>(<span class="params">res, status, content</span>)</span>&#123;</span><br><span class="line">	res.status(status);</span><br><span class="line">	res.json(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.missionsReadOne = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">	Missions</span><br><span class="line">		.findById(req.params.missionid)</span><br><span class="line">		.exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, mission</span>)</span>&#123;</span><br><span class="line">			sendJsonRes(res, <span class="number">200</span>, mission);</span><br><span class="line">		&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then, we want to add error checking like this: note that we can also utilize <code>console.log</code> to print out some useful information about the data in terminal since we use <code>nodemon</code>. </p>
<p>In real practice, we may not always want to retrive a whole document from mongodb, we may only just need some specific data. Thus, we can limit the data being passed around to improve speed, using <code>select</code> to retriece only “name” and “reviews” entry from a document in collection. Like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.reviewsReadOne = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(req.params &amp;&amp; req.params.missionid &amp;&amp; req.params.reviewid)&#123;</span><br><span class="line">		Missions</span><br><span class="line">			.findById(req.params.missionid)</span><br><span class="line">			.select(<span class="string">'name reviews'</span>)</span><br><span class="line">			.exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, mission</span>)</span>&#123;</span><br><span class="line">				<span class="keyword">if</span>(!mission)&#123;</span><br><span class="line">					sendJsonRes(res, <span class="number">404</span>, &#123;</span><br><span class="line">						<span class="string">"message"</span>: <span class="string">"missionid not found"</span></span><br><span class="line">					&#125;)</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;<span class="keyword">else</span> <span class="keyword">if</span>(err)&#123;</span><br><span class="line">					sendJsonRes(res, <span class="number">404</span>, err);</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">var</span> response, review;</span><br><span class="line">				review = mission.reviews.id(req.params.reviewid);</span><br><span class="line">				<span class="keyword">if</span>(!review)&#123;</span><br><span class="line">					sendJsonRes(res, <span class="number">404</span>, &#123;</span><br><span class="line">						<span class="string">"message"</span>: <span class="string">"reviewid not found!"</span></span><br><span class="line">					&#125;)</span><br><span class="line">					<span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				response = &#123;</span><br><span class="line">					mission: &#123;</span><br><span class="line">						name: mission.name,</span><br><span class="line">						id: req.params.missionid</span><br><span class="line">					&#125;,</span><br><span class="line">					reviews: review</span><br><span class="line">				&#125;;</span><br><span class="line">				sendJsonRes(res, <span class="number">200</span>, response);</span><br><span class="line">			&#125;);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		sendJsonRes(res, <span class="number">404</span>, &#123;</span><br><span class="line">			<span class="string">"message"</span>: <span class="string">"No missionid or reviewid in request"</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Apart from the error checking in the above code, we can use <code>id</code> to query subdocument the <code>_id</code> entry. <strong>note that in the raw data, I mistakenly put the entry name to be <code>id</code> instead of <code>_id</code>, which causes me to re-insert the data again to let the <code>id()</code> work for subdocument.</strong></p>
<p>These above example codes shows us how to simulate “GET” request for mission and reviews in “missions” collection in live mongolab database. When it comes to geo-query, we need to query the longtitude and latitude in <code>req.query</code> with some urls like this: <code>api/missions?lng=-12.34343434&amp;lat=51.22424224</code>.</p>
<p>Besides, the way writing the js code is quite important using closure!! I use an example that will be reused in later geo-distance calculation to illustrate how to <strong>only expost functions for later use with closure to wrap the inner variables from outer collisions.</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> theEarth = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> earthRadius = <span class="number">6371</span>;</span><br><span class="line">  <span class="keyword">var</span> getDistanceFromRads = <span class="function"><span class="keyword">function</span>(<span class="params">rads</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseFloat</span>(earthRadius * rads);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> getRadsFromDistance = <span class="function"><span class="keyword">function</span>(<span class="params">distance</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">parseFloat</span>(distance/getRadsFromDistance);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    getDistanceFromRads: getDistanceFromRads,</span><br><span class="line">    getRadsFromDistance: getRadsFromDistance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<p>Then the complete geo searching functions are:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for main page listing by distance.</span></span><br><span class="line"><span class="keyword">var</span> resToList = <span class="function"><span class="keyword">function</span>(<span class="params">results</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">var</span> lst = [];</span><br><span class="line">	results.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">doc</span>)</span>&#123;</span><br><span class="line">		lst.push(&#123;</span><br><span class="line">				distance: theEarth.getDistanceFromRads(doc.dis),</span><br><span class="line">				name: doc.obj.name,</span><br><span class="line">				author: doc.obj.author,</span><br><span class="line">				rating: doc.obj.rating,</span><br><span class="line">				tags: doc.obj.tag,</span><br><span class="line">				_id: doc.obj._id</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;)</span><br><span class="line">	<span class="keyword">return</span> lst;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.missionsListByDistance = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(req.query.lng &amp;&amp; req.query.lat)&#123;</span><br><span class="line">		<span class="keyword">var</span> lng = <span class="built_in">parseFloat</span>(req.query.lng);</span><br><span class="line">		<span class="keyword">var</span> lat = <span class="built_in">parseFloat</span>(req.query.lat);</span><br><span class="line">		<span class="keyword">var</span> point = &#123;</span><br><span class="line">			type: <span class="string">"Point"</span>,</span><br><span class="line">			coordinates: [lng, lat]</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="keyword">var</span> geoOptions = &#123;</span><br><span class="line">			spherical: <span class="literal">true</span>,</span><br><span class="line">			maxDistance: theEarth.getRadsFromDistance(<span class="built_in">parseInt</span>(req.query.maxdistance||<span class="number">2000</span>)),</span><br><span class="line">			num: <span class="number">10</span>,</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">// console.log(geoOptions.maxDistance);</span></span><br><span class="line">		Missions.geoNear(point, geoOptions, <span class="function"><span class="keyword">function</span>(<span class="params">err, results, stats</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err)&#123;</span><br><span class="line">				sendJsonRes(res, <span class="number">404</span>, err);</span><br><span class="line">				<span class="keyword">return</span> ;</span><br><span class="line">			&#125;</span><br><span class="line">			sendJsonRes(res, <span class="number">200</span>, resToList(results));</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		sendJsonRes(res, <span class="number">404</span>, &#123;</span><br><span class="line">			<span class="string">"message"</span>: <span class="string">"Found no longtitue or lattitude in query string."</span></span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>So far, we complete all three “GET” methods for this website, namely, [1]ListByDistance for the main page “/api/missions”; [2]get a single mission information for each mission document in db “/api/missions/&lt;_id&gt;”; [3]get a single review information for reviews from each mission document as subdocument “/api/missions/&lt;_id&gt;/reviews/&lt;_id&gt;”. And next, we will look at other methods like “POST”, “PUT” and “DELETE”.</p>
</blockquote>
<h2 id="“POST”-method-implementation"><a href="#“POST”-method-implementation" class="headerlink" title="“POST” method implementation"></a>“POST” method implementation</h2><p>In this project, since we only involve missions and reviews, we need to implement new mission post and new review post from form data, which is stored at <code>req.body.&lt;attr&gt;</code>.<br>The way we create an document is using <code>create()</code> directly :</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports.missionsCreate = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">	Missions.create(&#123;</span><br><span class="line">		name: req.body.name,</span><br><span class="line">		rating: req.body.rating,</span><br><span class="line">		tag: req.body.tags.split(<span class="string">","</span>),</span><br><span class="line">		author: req.body.author,</span><br><span class="line">		coords: [<span class="built_in">parseFloat</span>(req.body.lng), <span class="built_in">parseFloat</span>(req.body.lat)],</span><br><span class="line">		timepanel: &#123;</span><br><span class="line">			title: req.body.timetitle,</span><br><span class="line">			timeslots: req.body.timeslots.split(<span class="string">","</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err, mission</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			sendJsonRes(res, <span class="number">404</span>, err);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			sendJsonRes(res, <span class="number">201</span>, mission);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For subdocuments or facing with a list instead of an array, we probably just retrieve that list and <code>push</code> a new item into the list. Then we just need to <code>&lt;instance&gt;.save()</code> to save the item like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> addReiview = <span class="function"><span class="keyword">function</span>(<span class="params">req, res, mission</span>)</span>&#123;</span><br><span class="line">	mission.reviews.push(&#123;</span><br><span class="line">		rating: req.body.rating,</span><br><span class="line">		author: req.body.author,</span><br><span class="line">		text: req.body.text</span><br><span class="line">	&#125;)</span><br><span class="line">	mission.save(<span class="function"><span class="keyword">function</span>(<span class="params">err, mission</span>)</span>&#123;</span><br><span class="line">		<span class="keyword">var</span> thisReview;</span><br><span class="line">		<span class="keyword">if</span>(err)&#123;</span><br><span class="line">			sendJsonRes(res, <span class="number">404</span>, err);</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			updateAveRating(mission._id);</span><br><span class="line">			thisReview = mission.reviews[mission.reviews.length - <span class="number">1</span>];</span><br><span class="line">			sendJsonRes(res, <span class="number">201</span>, thisReview);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="“PUT”-method-implementation"><a href="#“PUT”-method-implementation" class="headerlink" title="“PUT” method implementation"></a>“PUT” method implementation</h2><p>“PUT” method is similar to “POST” in a way that they both use form data stored in <code>req.body</code>, while one is create from nothing and add to the database, the other is to find an existing one and update part of the information. </p>
<ul>
<li>One hack I thought about is to use <code>Object.keys(obj)</code> to obtain the keys from a js object, then using <code>$set</code> in <code>mongo.update()</code> to only update the value in body? <strong>Ideas:</strong> this idea only works when all field are requiring same manipulation from body data. To be more specifically, some data are needed to be processed to feed for later use, such as we add <code>.split(&quot;,&quot;);</code> for tags data, and some fields like “coords” is an array. Thus, if we want to apply more operations on some data, we cannot just treat them in the same way in a for loop</li>
<li>Or, utilize the the way mongoose model treat model parameters, we can do <code>var newReview = new Review(req.body)</code> to create an instance of “Review” model, then use this to replace the old one?</li>
</ul>
<blockquote>
<p>One important thing to notice is that when we save, we save <strong>parent document!</strong> In our case, we did <code>mission.save(function(err, mission))</code> instead of <code>review.save(...)</code>!</p>
</blockquote>
<h2 id="“DELETE”-method-implementation"><a href="#“DELETE”-method-implementation" class="headerlink" title="“DELETE” method implementation"></a>“DELETE” method implementation</h2><p>“DELETE” method is easier, we only need to find that document by “missionid”, then do <code>Missions.remove(function(err, mission))</code>. For the subdocument, we simply find that subdocument and call remove at the end. The prototype is like:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A working prototype without error checking.</span></span><br><span class="line"><span class="built_in">module</span>.exports.reviewsDeleteOne = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>)</span>&#123;</span><br><span class="line">	Missions</span><br><span class="line">		.findById(req.params.missionid)</span><br><span class="line">		.select(<span class="string">"reviews"</span>)</span><br><span class="line">		.exec(<span class="function"><span class="keyword">function</span>(<span class="params">err, mission</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(err)&#123;</span><br><span class="line">				sendJsonRes(res, <span class="number">404</span>, &#123;</span><br><span class="line">					<span class="string">"message"</span>: <span class="string">"Found no match"</span></span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;</span><br><span class="line">			mission.reviews.id(req.params.reviewid).remove();</span><br><span class="line">			mission.save(<span class="function"><span class="keyword">function</span>(<span class="params">err, mission</span>)</span>&#123; <span class="comment">// save parent document.</span></span><br><span class="line">				updateAveRating(mission._id);</span><br><span class="line">				sendJsonRes(res, <span class="number">204</span>, <span class="literal">null</span>);</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Summery"><a href="#Summery" class="headerlink" title="Summery"></a>Summery</h2><ul>
<li><p>How to insert an common model instance into mongodb? I mean, since we can’t generate the “_id” by ourselves, then how comes we insert such object into <code>mongo</code>? <strong>Answer:</strong> we need to know the difference between <code>db.missions.save</code> and <code>db.missions.insert</code>, using <code>save</code>, we can simple provide an model instance according to the model schma, while using using <code>insert</code>, we have to write the object exacty the same as the final document! </p>
</li>
<li><p>“GET” method implementation? <strong>Answer:</strong> using mongodb query like <code>findById</code> and others to get the document from db, and sometimes we need <code>id</code> to retrieve info from subdocument. Besides, <code>geoNear</code> is handy in mongodb to get displaying documents by distance.</p>
</li>
<li><p>Some important places for error checking: </p>
<ul>
<li>If argument is in the <code>req.body</code> or <code>req.query</code> or <code>req.params</code>. <strong>if not, return a message in <code>res</code> saying founding no argument in coming request.</strong></li>
<li>Then given an ID(probably), we may want to search that document in database using <code>getById()</code>, and the callback function contains an <code>error</code> object and a instance object, where the returning instance object indicates whether or not searching database is succeeded or not. <strong>If not, return a message saying object not found in database.</strong></li>
<li>When we tried to update of create a new document, we may usually use <code>save</code> and <code>create</code>, the callback function contains an error object either, <strong>it indicates whether or not such instance can be created or updated correctly, if the error message appears, it usually dues to the fact that some fields violates the validation rules specified in database schema.</strong></li>
</ul>
</li>
</ul>
<h2 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h2><ul>
<li>Unless you fancy adding hundreds of script tags to your pages, you need a build tool to bundle your dependencies. You also need something to <strong>allow NPM packages to work in browsers</strong>. This is where Webpack comes in.</li>
<li>Add a .gitattributes file and push it to github to overwrite the project type calculated by github, adding <code>*.css linguist-language=Javascript</code> into the file to let a specific file being overwritten.</li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>一起加油！</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/wechatpay.png" alt="余舜哲 WeChat Pay"/>
          <p>微信打赏</p>
        </div>
      
      
    </div>
  </div>


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/javascript/" rel="tag">#javascript</a>
          
            <a href="/tags/nodejs/" rel="tag">#nodejs</a>
          
            <a href="/tags/web-design/" rel="tag">#web design</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/03/11/MEAN全栈开发-第二期-前端实战手记/" rel="next" title="MEAN全栈开发[第二期-前端实战手记]">
                <i class="fa fa-chevron-left"></i> MEAN全栈开发[第二期-前端实战手记]
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/04/23/创意视频分屏-HTML5-JS/" rel="prev" title="创意视频分屏 - HTML5 & JS">
                创意视频分屏 - HTML5 & JS <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      

      
        <h3> 相关文章：</h3><ul class="related-posts"><li><a href="/2016/03/11/MEAN全栈开发-第二期-前端实战手记/">MEAN全栈开发[第二期-前端实战手记]</a></li><li><a href="/2016/02/04/Responsive-web-design-第三期-js动画/">Responsive web design[第三期]-js动画</a></li><li><a href="/2016/05/23/socket-io开发多人聊天室教程/">socket.io开发多人聊天室教程</a></li><li><a href="/2016/05/15/前端开发工具库-第一期-npm-script/">前端开发工具库[第一期]-npm script</a></li><li><a href="/2016/04/23/创意视频分屏-HTML5-JS/">创意视频分屏 - HTML5 & JS</a></li><li><a href="/2016/03/06/MEAN全栈开发-第一期-前端布局/">MEAN全栈开发[第一期-前端布局]</a></li><li><a href="/2016/05/04/AWS-elastic-beanstalk使用体验/">AWS elastic beanstalk使用体验</a></li><li><a href="/2016/02/20/Ajax-with-Jquery-on-Nodejs-server/">Ajax(with Jquery) on Nodejs server</a></li><li><a href="/2016/08/01/React-ES6-style-guideline/">React/ES6 style guideline</a></li><li><a href="/2016/01/06/Twitter-engine-in-React/">Twitter engine in React</a></li></ul>
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-overlay"></div>
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ww3.sinaimg.cn/large/c5ee78b5gw1ez498sfwnuj208w08wmxt.jpg"
               alt="余舜哲" />
          <p class="site-author-name" itemprop="name">余舜哲</p>
          <p class="site-description motion-element" itemprop="description">技术就是信仰</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">79</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">37</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/chocoluffy" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/chocoluffy" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.douban.com/people/chocolufy/" target="_blank" title="豆瓣">
                  
                    <i class="fa fa-fw fa-book"></i>
                  
                  豆瓣
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mongoose"><span class="nav-number">2.</span> <span class="nav-text">Mongoose</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#REST-APIs"><span class="nav-number">3.</span> <span class="nav-text">REST APIs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“GET”-method-implementation"><span class="nav-number">4.</span> <span class="nav-text">“GET” method implementation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“POST”-method-implementation"><span class="nav-number">5.</span> <span class="nav-text">“POST” method implementation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“PUT”-method-implementation"><span class="nav-number">6.</span> <span class="nav-text">“PUT” method implementation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#“DELETE”-method-implementation"><span class="nav-number">7.</span> <span class="nav-text">“DELETE” method implementation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summery"><span class="nav-number">8.</span> <span class="nav-text">Summery</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Tools"><span class="nav-number">9.</span> <span class="nav-text">Tools</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">余舜哲</span>
  <span class="post-count"> | 博客全站共191.9k字</span>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
    <span class="site-pv">你是第<span class="busuanzi-value" id="busuanzi_value_site_pv"></span>个小伙伴</span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/velocity/1.3.1/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'chocoluffy';
      var disqus_identifier = '2016/03/22/MEAN全栈开发-第三期-Mongo数据库搭建REST-API/';
      var disqus_title = 'MEAN全栈开发[第三期-Mongo数据库搭建REST API]';
      var disqus_url = 'http://chocoluffy.com/2016/03/22/MEAN全栈开发-第三期-Mongo数据库搭建REST-API/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  



  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  

  

</body>
</html>
